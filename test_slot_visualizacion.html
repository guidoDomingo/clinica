<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Visualización de Slots</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .slot-horario {
            cursor: pointer;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            transition: all 0.3s;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        
        .slot-horario:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }
        
        .slot-horario.selected {
            background-color: #007bff;
            color: white;
            border-color: #0069d9;
        }
        
        .no-disponible {
            background-color: #f8d7da;
            color: #721c24;
            cursor: not-allowed;
        }
        
        .no-disponible:hover {
            background-color: #f5c6cb;
        }
        
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body class="container py-4">
    <h1 class="mb-4">Test de Visualización de Slots</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Datos de prueba</h4>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="jsonData">JSON de slots:</label>
                        <textarea id="jsonData" class="form-control" rows="10">
{
    "status": "success",
    "data": [
        {
            "agenda_id": 18,
            "horario_id": 19,
            "turno_id": 1,
            "turno_nombre": "MAÑANA",
            "sala_id": 1,
            "sala_nombre": "Sala 1",
            "doctor_id": 14,
            "nombre_doctor": "Ricardo Mendez",
            "hora_inicio": "08:00:00",
            "hora_fin": "08:30:00",
            "duracion_minutos": 30,
            "tipo_horario": "NORMAL"
        },
        {
            "agenda_id": 18,
            "horario_id": 19,
            "turno_id": 1,
            "turno_nombre": "MAÑANA",
            "sala_id": 1,
            "sala_nombre": "Sala 2",
            "doctor_id": 14,
            "nombre_doctor": "Ricardo Mendez",
            "hora_inicio": "08:30:00",
            "hora_fin": "09:00:00",
            "duracion_minutos": 30,
            "tipo_horario": "NORMAL"
        }
    ]
}
                        </textarea>
                    </div>
                    <div class="form-group">
                        <label>Formato de datos:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dataFormat" id="formatStandard" value="standard" checked>
                            <label class="form-check-label" for="formatStandard">
                                Estándar (hora_inicio/hora_fin)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dataFormat" id="formatAlt" value="alt">
                            <label class="form-check-label" for="formatAlt">
                                Alternativo (inicio/fin)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="dataFormat" id="formatEng" value="eng">
                            <label class="form-check-label" for="formatEng">
                                Inglés (start_time/end_time)
                            </label>
                        </div>
                    </div>
                    <button id="btnRender" class="btn btn-primary">Renderizar slots</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h4>Horario seleccionado</h4>
                </div>
                <div class="card-body">
                    <div id="seleccionInfo">
                        <div class="alert alert-info">Ningún horario seleccionado.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Visualización de slots</h4>
                    <span id="slotCount" class="badge badge-primary">0</span>
                </div>
                <div class="card-body">
                    <div id="contenedorHorarios" class="row">
                        <div class="col-12">
                            <div class="alert alert-info">
                                Ingrese datos y pulse "Renderizar slots"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Evento para renderizar los slots
            $('#btnRender').click(function() {
                try {
                    // Obtener el JSON ingresado
                    const jsonText = $('#jsonData').val();
                    const respuesta = JSON.parse(jsonText);
                    
                    // Verificar formato de datos seleccionado
                    const formato = $('input[name="dataFormat"]:checked').val();
                    
                    renderizarSlots(respuesta, formato);
                } catch (e) {
                    $('#contenedorHorarios').html(`
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Error al procesar el JSON: ${e.message}
                            </div>
                        </div>
                    `);
                }
            });
            
            // Evento para seleccionar un slot horario
            $(document).on('click', '.slot-horario', function() {
                // Verificar si el slot está disponible
                if ($(this).hasClass('no-disponible')) {
                    return;
                }
                
                // Quitar selección anterior
                $('.slot-horario').removeClass('selected');
                
                // Seleccionar este slot
                $(this).addClass('selected');
                
                // Mostrar información de la selección
                const slotId = $(this).data('id');
                const horaInicio = $(this).data('inicio');
                const horaFin = $(this).data('fin');
                const textoHorario = $(this).data('texto');
                const nombreSala = $(this).data('sala') || 'Sin sala asignada';
                
                $('#seleccionInfo').html(`
                    <dl class="row mb-0">
                        <dt class="col-sm-4">ID:</dt>
                        <dd class="col-sm-8">${slotId || 'No disponible'}</dd>
                        
                        <dt class="col-sm-4">Horario:</dt>
                        <dd class="col-sm-8">${textoHorario}</dd>
                        
                        <dt class="col-sm-4">Hora inicio:</dt>
                        <dd class="col-sm-8">${horaInicio || 'No disponible'}</dd>
                        
                        <dt class="col-sm-4">Hora fin:</dt>
                        <dd class="col-sm-8">${horaFin || 'No disponible'}</dd>
                        
                        <dt class="col-sm-4">Sala:</dt>
                        <dd class="col-sm-8">${nombreSala}</dd>
                    </dl>
                `);
            });
        });
        
        // Función para renderizar los slots según el formato
        function renderizarSlots(respuesta, formato) {
            if (respuesta.data && respuesta.data.length > 0) {
                // Construir la rejilla de slots horarios
                const slots = respuesta.data;
                let htmlSlots = '<div class="row">';
                
                // Actualizar contador
                $('#slotCount').text(slots.length);
                
                // Preparar los datos según el formato seleccionado
                if (formato === 'alt') {
                    // Convertir de hora_inicio/hora_fin a inicio/fin
                    slots.forEach(slot => {
                        if (slot.hora_inicio) {
                            slot.inicio = slot.hora_inicio;
                            delete slot.hora_inicio;
                        }
                        if (slot.hora_fin) {
                            slot.fin = slot.hora_fin;
                            delete slot.hora_fin;
                        }
                    });
                } else if (formato === 'eng') {
                    // Convertir de hora_inicio/hora_fin a start_time/end_time
                    slots.forEach(slot => {
                        if (slot.hora_inicio) {
                            slot.start_time = slot.hora_inicio;
                            delete slot.hora_inicio;
                        }
                        if (slot.hora_fin) {
                            slot.end_time = slot.hora_fin;
                            delete slot.hora_fin;
                        }
                    });
                }
                
                slots.forEach(function(slot) {
                    // Determinar si el slot está disponible
                    const disponible = slot.disponible !== false; // Por defecto, asumimos disponible
                    const claseDisponibilidad = disponible ? '' : 'no-disponible';
                    
                    // Formatear las horas para mostrar (HH:MM)
                    // Manejar diferentes formatos de respuesta de la API
                    let horaInicio = '??:??';
                    let horaFin = '??:??';
                    
                    let horaInicioValor = '';
                    let horaFinValor = '';
                    
                    if (slot.hora_inicio) {
                        horaInicio = slot.hora_inicio.substring(0, 5);
                        horaInicioValor = slot.hora_inicio;
                    } else if (slot.inicio) {
                        horaInicio = slot.inicio.substring(0, 5);
                        horaInicioValor = slot.inicio;
                    } else if (slot.start_time) {
                        horaInicio = slot.start_time.substring(0, 5);
                        horaInicioValor = slot.start_time;
                    }
                    
                    if (slot.hora_fin) {
                        horaFin = slot.hora_fin.substring(0, 5);
                        horaFinValor = slot.hora_fin;
                    } else if (slot.fin) {
                        horaFin = slot.fin.substring(0, 5);
                        horaFinValor = slot.fin;
                    } else if (slot.end_time) {
                        horaFin = slot.end_time.substring(0, 5);
                        horaFinValor = slot.end_time;
                    }
                    
                    // Nombre de la sala
                    const nombreSala = slot.sala_nombre || 'Sin sala asignada';
                    
                    htmlSlots += `
                        <div class="col-md-6 col-sm-6 mb-3">
                            <div class="slot-horario ${claseDisponibilidad}" 
                                 data-id="${slot.horario_id || slot.id || ''}"
                                 data-inicio="${horaInicioValor}"
                                 data-fin="${horaFinValor}"
                                 data-texto="${horaInicio} - ${horaFin}"
                                 data-sala="${nombreSala}">
                                <p class="mb-1 text-center"><strong>${horaInicio} - ${horaFin}</strong></p>
                                <p class="mb-0 text-center"><small>${nombreSala}</small></p>
                            </div>
                        </div>
                    `;
                });
                
                htmlSlots += '</div>';
                $('#contenedorHorarios').html(htmlSlots);
            } else {
                $('#contenedorHorarios').html(`
                    <div class="col-12">
                        <div class="alert alert-warning">
                            No se encontraron slots disponibles.
                        </div>
                    </div>
                `);
            }
        }
    </script>
</body>
</html>
