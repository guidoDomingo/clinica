<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Eventos de Reservas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <style>
        #eventLog {
            height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }
        .log-info { color: #0066cc; }
        .log-warn { color: #ff9900; }
        .log-error { color: #cc0000; }
        .log-ajax { color: #6600cc; }
        #eventLog p { margin-bottom: 3px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Monitor de Eventos de Reservas</h1>
        <p class="lead">Esta herramienta monitorea los eventos JavaScript relacionados con la carga de reservas y los muestra para diagnóstico.</p>
        
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="date" id="fechaInput" class="form-control" value="<?php echo date('Y-m-d'); ?>">
                    <div class="input-group-append">
                        <button class="btn btn-primary" id="btnCargarReservas">Cargar reservas</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-secondary" id="btnClearLog">Limpiar Log</button>
                <button class="btn btn-danger ml-2" id="btnInspectJS">Inspeccionar JS</button>
            </div>
        </div>
        
        <div id="eventLog" class="mb-3">
            <!-- Aquí se mostrarán los logs de eventos -->
        </div>
        
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="card-title h5 mb-0">Reservas cargadas</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tablaReservas">
                        <thead>
                            <tr>
                                <th>Horario</th>
                                <th>Doctor</th>
                                <th>Paciente</th>
                                <th>Servicio</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center">No hay reservas cargadas</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h2 class="card-title h5 mb-0">Datos de respuesta JSON</h2>
            </div>
            <div class="card-body">
                <pre id="jsonResponse">Sin datos</pre>
            </div>
        </div>
        
        <div class="mt-3">
            <a href="crear_reserva_hoy.php" class="btn btn-success mr-2">Crear Reserva de Prueba</a>
            <a href="api_test_reservas.php" class="btn btn-warning mr-2">Probar API</a>
            <a href="test_ajax_reservas.php" class="btn btn-info">Probar AJAX</a>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sobreescribir console.log para capturar mensajes
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        console.log = function() {
            appendToLog('info', Array.from(arguments));
            originalConsoleLog.apply(console, arguments);
        };
        
        console.warn = function() {
            appendToLog('warn', Array.from(arguments));
            originalConsoleWarn.apply(console, arguments);
        };
        
        console.error = function() {
            appendToLog('error', Array.from(arguments));
            originalConsoleError.apply(console, arguments);
        };
        
        // Función para agregar mensajes al log
        function appendToLog(type, args) {
            const logElement = document.getElementById('eventLog');
            const logEntry = document.createElement('p');
            logEntry.className = 'log-' + type;
            
            const timestamp = new Date().toISOString().split('T')[1].substr(0, 12);
            let message = '[' + timestamp + '] ';
            
            args.forEach((arg, index) => {
                if (typeof arg === 'object') {
                    message += JSON.stringify(arg);
                } else {
                    message += arg;
                }
                
                if (index < args.length - 1) {
                    message += ' ';
                }
            });
            
            logEntry.textContent = message;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Interceptar llamadas AJAX
        const originalAjax = $.ajax;
        $.ajax = function(options) {
            appendToLog('ajax', ['AJAX Request:', options.url, options.data]);
            
            // Almacenar los callbacks originales
            const originalSuccess = options.success;
            const originalError = options.error;
            
            // Sobreescribir callbacks
            options.success = function(response) {
                appendToLog('ajax', ['AJAX Success:', options.url, response]);
                if (originalSuccess) {
                    originalSuccess.apply(this, arguments);
                }
            };
            
            options.error = function(xhr, status, error) {
                appendToLog('error', ['AJAX Error:', options.url, status, error]);
                if (originalError) {
                    originalError.apply(this, arguments);
                }
            };
            
            return originalAjax.apply($, arguments);
        };
        
        // Función para cargar reservas
        function cargarReservasDelDia(fecha) {
            console.log("Cargando reservas para la fecha: " + fecha);
            
            // Limpiar tabla
            $('#tablaReservas tbody').html('<tr><td colspan="5" class="text-center"><i class="spinner-border spinner-border-sm"></i> Cargando...</td></tr>');
            $('#jsonResponse').text('Cargando...');
            
            $.ajax({
                url: "ajax/servicios.ajax.php",
                method: "POST",
                data: { 
                    action: "obtenerReservas",
                    fecha: fecha
                },
                dataType: "json",
                success: function(respuesta) {
                    console.log("Respuesta de reservas:", respuesta);
                    
                    // Mostrar JSON completo
                    $('#jsonResponse').text(JSON.stringify(respuesta, null, 2));
                    
                    if (respuesta.status === "success" && respuesta.data && respuesta.data.length > 0) {
                        let filas = '';
                        
                        respuesta.data.forEach(function(reserva) {
                            console.log("Procesando reserva:", reserva);
                            
                            // Formatear la hora para mostrar (HH:MM)
                            const horaInicio = reserva.hora_inicio ? reserva.hora_inicio.substring(0, 5) : '';
                            const horaFin = reserva.hora_fin ? reserva.hora_fin.substring(0, 5) : '';
                            
                            // Determinar color según estado
                            let claseEstado = '';
                            const estado = (reserva.estado_reserva || reserva.estado || reserva.reserva_estado || 'PENDIENTE').toUpperCase();
                            
                            switch (estado) {
                                case 'PENDIENTE': claseEstado = 'badge-warning'; break;
                                case 'CONFIRMADA': claseEstado = 'badge-success'; break;
                                case 'CANCELADA': claseEstado = 'badge-danger'; break;
                                case 'COMPLETADA': claseEstado = 'badge-info'; break;
                                default: claseEstado = 'badge-secondary';
                            }
                            
                            // Obtener nombres con mejor manejo de posibles valores nulos o indefinidos
                            let doctorNombre = '';
                            if (reserva.doctor_nombre && reserva.doctor_nombre.trim() !== '' && !reserva.doctor_nombre.startsWith('Doctor ')) {
                                doctorNombre = reserva.doctor_nombre;
                            } else if (reserva.nombre_doctor && reserva.nombre_doctor.trim() !== '') {
                                doctorNombre = reserva.nombre_doctor;
                            } else {
                                doctorNombre = 'Dr. ' + (reserva.doctor_id || '?');
                            }
                            
                            let pacienteNombre = '';
                            if (reserva.paciente_nombre && reserva.paciente_nombre.trim() !== '' && !reserva.paciente_nombre.startsWith('Paciente ')) {
                                pacienteNombre = reserva.paciente_nombre;
                            } else if (reserva.nombre_paciente && reserva.nombre_paciente.trim() !== '') {
                                pacienteNombre = reserva.nombre_paciente;
                            } else {
                                pacienteNombre = 'Paciente ' + (reserva.paciente_id || '?');
                            }
                            
                            let servicioNombre = '';
                            if (reserva.servicio_nombre && reserva.servicio_nombre.trim() !== '' && !reserva.servicio_nombre.startsWith('Servicio ')) {
                                servicioNombre = reserva.servicio_nombre;
                            } else if (reserva.nombre && reserva.nombre.trim() !== '') {
                                // Campo nombre de rs_servicios
                                servicioNombre = reserva.nombre;
                            } else {
                                servicioNombre = 'Servicio ' + (reserva.servicio_id || '?');
                            }
                            
                            filas += `
                                <tr>
                                    <td>${horaInicio} - ${horaFin}</td>
                                    <td>${doctorNombre}</td>
                                    <td>${pacienteNombre}</td>
                                    <td>${servicioNombre}</td>
                                    <td><span class="badge ${claseEstado}">${estado}</span></td>
                                </tr>
                            `;
                        });
                        
                        $('#tablaReservas tbody').html(filas);
                    } else {
                        console.log("No hay reservas o error en la respuesta:", respuesta);
                        $('#tablaReservas tbody').html('<tr><td colspan="5" class="text-center">No hay reservas para esta fecha</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar reservas:", xhr, status, error);
                    $('#tablaReservas tbody').html('<tr><td colspan="5" class="text-center text-danger">Error al cargar reservas: ' + error + '</td></tr>');
                    $('#jsonResponse').text('Error: ' + error);
                }
            });
        }
        
        // Eventos del DOM
        $(document).ready(function() {
            appendToLog('info', ['Página cargada']);
            
            $('#btnCargarReservas').click(function() {
                const fecha = $('#fechaInput').val();
                cargarReservasDelDia(fecha);
            });
            
            $('#btnClearLog').click(function() {
                $('#eventLog').empty();
                appendToLog('info', ['Log limpiado']);
            });
            
            $('#btnInspectJS').click(function() {
                appendToLog('info', ['Inspeccionando servicios.js...']);
                $.ajax({
                    url: 'view/js/servicios.js',
                    method: 'GET',
                    dataType: 'text',
                    success: function(data) {
                        // Buscar funciones relacionadas con reservas
                        const funciones = data.match(/function\s+\w+\([^)]*\)/g) || [];
                        appendToLog('info', ['Funciones encontradas:', funciones.length]);
                        funciones.forEach(fn => {
                            if (fn.includes('cargarReservas') || fn.includes('reserva') || fn.includes('Reserva')) {
                                appendToLog('info', ['Función relacionada:', fn]);
                            }
                        });
                        
                        // Buscar llamadas AJAX para reservas
                        const regex = /\.ajax\(\{[^}]*action:\s*["']obtenerReservas["'][^}]*\}\)/g;
                        const ajaxCalls = data.match(regex) || [];
                        appendToLog('info', ['Llamadas AJAX a obtenerReservas:', ajaxCalls.length]);
                    },
                    error: function(xhr, status, error) {
                        appendToLog('error', ['Error al cargar servicios.js:', error]);
                    }
                });
            });
            
            // Cargar reservas al inicio para la fecha actual
            const fechaInicial = $('#fechaInput').val();
            cargarReservasDelDia(fechaInicial);
        });
    </script>
</body>
</html>
